substitutions:
  device_name: spa-controller

esphome:
  name: ${device_name}
  friendly_name: Spa Controller
  includes:
    - spa_protocol.h

esp32:
  board: featheresp32-s2
  framework:
    type: arduino

logger:
  level: DEBUG
  baud_rate: 0

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

api:
  encryption:
    key: !secret api_encryption_key

ota:
  platform: esphome
  password: !secret ota_password

# Time component for notification date calculations
time:
  - platform: sntp
    id: sntp_time
    timezone: Europe/Stockholm

# UART connection to Arduino I2C Proxy
uart:
  id: arduino_uart
  tx_pin: GPIO5
  rx_pin: GPIO16
  baud_rate: 115200
  rx_buffer_size: 512

# Spa Protocol Component - handles all I2C protocol logic
# The SpaProtocol instance is stored in a global for access from lambdas
globals:
  - id: spa_protocol_instance
    type: void*
    initial_value: "nullptr"

# Custom component that creates the SpaProtocol
# Must be first so other components can reference it
sensor:
  - platform: custom
    lambda: |-
      auto proto = new SpaProtocol(id(arduino_uart));
      id(spa_protocol_instance) = proto;
      App.register_component(proto);
      return {};
    sensors: []

  # Notification sensors (days remaining until maintenance due)
  - platform: template
    id: rinse_filter_sensor
    name: "Spa Rinse Filter"
    icon: "mdi:air-filter"
    unit_of_measurement: "days"
    accuracy_decimals: 0

  - platform: template
    id: clean_filter_sensor
    name: "Spa Clean Filter"
    icon: "mdi:vacuum"
    unit_of_measurement: "days"
    accuracy_decimals: 0

  - platform: template
    id: change_water_sensor
    name: "Spa Change Water"
    icon: "mdi:water-sync"
    unit_of_measurement: "days"
    accuracy_decimals: 0

  - platform: template
    id: spa_checkup_sensor
    name: "Spa Checkup"
    icon: "mdi:wrench-clock"
    unit_of_measurement: "days"
    accuracy_decimals: 0

# Switches for controlling spa
switch:
  - platform: template
    id: light_switch
    name: "Spa Light"
    icon: "mdi:lightbulb"
    optimistic: false
    lambda: |-
      auto proto = (SpaProtocol*)id(spa_protocol_instance);
      if (proto) return proto->get_light_state();
      return false;
    turn_on_action:
      - lambda: |-
          auto proto = (SpaProtocol*)id(spa_protocol_instance);
          if (proto) proto->send_light_command(true);
    turn_off_action:
      - lambda: |-
          auto proto = (SpaProtocol*)id(spa_protocol_instance);
          if (proto) proto->send_light_command(false);

  - platform: template
    id: pump_switch
    name: "Spa Pump"
    icon: "mdi:pump"
    optimistic: false
    lambda: |-
      auto proto = (SpaProtocol*)id(spa_protocol_instance);
      if (proto) return proto->get_pump_state();
      return false;
    turn_on_action:
      - lambda: |-
          auto proto = (SpaProtocol*)id(spa_protocol_instance);
          if (proto) proto->send_pump_command(true);
    turn_off_action:
      - lambda: |-
          auto proto = (SpaProtocol*)id(spa_protocol_instance);
          if (proto) proto->send_pump_command(false);

  - platform: template
    id: circ_switch
    name: "Spa Circulation"
    icon: "mdi:rotate-3d-variant"
    optimistic: false
    lambda: |-
      auto proto = (SpaProtocol*)id(spa_protocol_instance);
      if (proto) return proto->get_circ_state();
      return false;
    turn_on_action:
      - lambda: |-
          auto proto = (SpaProtocol*)id(spa_protocol_instance);
          if (proto) proto->send_circ_command(true);
    turn_off_action:
      - lambda: |-
          auto proto = (SpaProtocol*)id(spa_protocol_instance);
          if (proto) proto->send_circ_command(false);

# Program selector
select:
  - platform: template
    id: program_select
    name: "Spa Program"
    icon: "mdi:format-list-bulleted"
    options:
      - "Away"
      - "Standard"
      - "Energy"
      - "Super Energy"
      - "Weekend"
    initial_option: "Standard"
    optimistic: true
    set_action:
      - lambda: |-
          auto proto = (SpaProtocol*)id(spa_protocol_instance);
          if (!proto) return;
          int prog = 1;
          if (x == "Away") prog = 0;
          else if (x == "Standard") prog = 1;
          else if (x == "Energy") prog = 2;
          else if (x == "Super Energy") prog = 3;
          else if (x == "Weekend") prog = 4;
          proto->send_program_command(prog);

# Climate entity for temperature control
climate:
  - platform: custom
    lambda: |-
      auto proto = (SpaProtocol*)id(spa_protocol_instance);
      auto climate = new SpaClimate(proto);
      if (proto) proto->set_climate(climate);
      App.register_component(climate);
      return {climate};
    climates:
      - id: spa_climate
        name: "Spa"

# Binary sensors for status
binary_sensor:
  - platform: template
    id: standby_sensor
    name: "Spa Standby"
    icon: "mdi:power-standby"

  - platform: template
    id: connected_sensor
    name: "Spa Connected"
    icon: "mdi:connection"
    device_class: connectivity

# Register entity pointers with SpaProtocol after they're created
interval:
  - interval: 1s
    startup_delay: 2s
    then:
      - lambda: |-
          static bool initialized = false;
          if (!initialized) {
            auto proto = (SpaProtocol*)id(spa_protocol_instance);
            if (proto) {
              proto->set_light_switch(id(light_switch));
              proto->set_pump_switch(id(pump_switch));
              proto->set_circ_switch(id(circ_switch));
              proto->set_program_select(id(program_select));
              proto->set_standby_sensor(id(standby_sensor));
              proto->set_connected_sensor(id(connected_sensor));
              proto->set_rinse_filter_sensor(id(rinse_filter_sensor));
              proto->set_clean_filter_sensor(id(clean_filter_sensor));
              proto->set_change_water_sensor(id(change_water_sensor));
              proto->set_spa_checkup_sensor(id(spa_checkup_sensor));
              initialized = true;
              ESP_LOGI("spa", "Entity pointers registered with SpaProtocol");
            }
          }

# Button to manually request status
button:
  - platform: template
    name: "Refresh Spa Status"
    icon: "mdi:refresh"
    on_press:
      - lambda: |-
          auto proto = (SpaProtocol*)id(spa_protocol_instance);
          if (proto) proto->request_status();
